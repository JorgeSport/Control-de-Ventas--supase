<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Control de Ventas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://esm.sh">
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="bg-indigo-600 text-white">
    <div class="max-w-5xl mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h1 class="text-2xl font-bold">Control de Ventas</h1>
      <div class="flex gap-2">
        <button id="add-sale-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">
          Registrar Venta
        </button>
        <button id="migrate-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded"
          title="Sube tus ventas locales (IDs numéricos) a Supabase">
          Migrar a la nube
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- KPIs simples (puedes extenderlos) -->
    <section id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded shadow p-4">
        <div class="text-gray-500">Ventas</div>
        <div id="kpi-count" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-gray-500">Total (S/)</div>
        <div id="kpi-total" class="text-2xl font-bold">0</div>
      </div>
      <div class="bg-white rounded shadow p-4">
        <div class="text-gray-500">Pagadas</div>
        <div id="kpi-paid" class="text-2xl font-bold">0</div>
      </div>
    </section>

    <!-- Tabla -->
    <section class="bg-white rounded shadow overflow-hidden">
      <table class="w-full">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th class="text-left p-3">Cliente</th>
            <th class="text-left p-3">Contacto</th>
            <th class="text-left p-3">Producto</th>
            <th class="text-left p-3">Total</th>
            <th class="text-left p-3">Estado</th>
            <th class="text-left p-3">Acciones</th>
          </tr>
        </thead>
        <tbody id="sales-table-body" class="divide-y divide-gray-100"></tbody>
      </table>
    </section>
  </main>

  <!-- Modal -->
  <div id="sale-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <h2 class="text-lg font-semibold">Registrar / Editar Venta</h2>
        <button id="close-modal" class="text-gray-500 hover:text-gray-900">&times;</button>
      </div>
      <form id="sale-form" class="p-5 grid grid-cols-1 gap-3">
        <input type="hidden" id="sale-id">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Cliente *</label>
            <input id="buyer-name" class="w-full border rounded px-3 py-2" placeholder="Nombre del cliente" required>
          </div>
          <div>
            <label class="text-sm text-gray-600">Contacto (tel / WhatsApp)</label>
            <input id="buyer-contact" class="w-full border rounded px-3 py-2" placeholder="+34 600 000 000">
          </div>
        </div>

        <div>
          <label class="text-sm text-gray-600">Producto *</label>
          <input id="product-name" class="w-full border rounded px-3 py-2" placeholder="Nombre del producto" required>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-gray-600">Precio total *</label>
            <input id="total-price" type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="0.00" required>
          </div>
          <div>
            <label class="text-sm text-gray-600">Condición</label>
            <select id="product-condition" class="w-full border rounded px-3 py-2">
              <option>Nuevo</option>
              <option>Usado - Como nuevo</option>
              <option>Usado - Buen estado</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm text-gray-600">Adelanto (S/)</label>
            <input id="deposit" type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="0.00">
          </div>
          <div>
            <label class="text-sm text-gray-600">Costo compra (EUR)</label>
            <input id="purchase-price-eur" type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="0.00">
          </div>
          <div>
            <label class="text-sm text-gray-600">Estado</label>
            <select id="status" class="w-full border rounded px-3 py-2">
              <option>📋 Compra Registrada</option>
              <option>💰 Pagado</option>
              <option>🚚 Enviado</option>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-5">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="adelanto-pagado" type="checkbox"> Adelanto pagado
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="saldo-pagado" type="checkbox"> Saldo pagado
          </label>
        </div>

        <!-- Enlaces de producto (opcionales) -->
        <div>
          <label class="text-sm text-gray-600">Enlaces del producto (opcional)</label>
          <div id="links-container" class="space-y-2">
            <input class="product-link-input w-full border rounded px-3 py-2" placeholder="https://...">
          </div>
          <button type="button" id="add-link" class="mt-2 text-indigo-600 hover:underline text-sm">+ Añadir enlace</button>
        </div>

        <div class="flex items-center justify-end gap-3 pt-2 border-t">
          <button type="button" id="cancel-sale-btn" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- App (no-module) -->
  <script>
    const tableBody = document.getElementById('sales-table-body');
    const kpiCount = document.getElementById('kpi-count');
    const kpiTotal = document.getElementById('kpi-total');
    const kpiPaid  = document.getElementById('kpi-paid');

    const modal = document.getElementById('sale-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const addSaleBtn = document.getElementById('add-sale-btn');
    const cancelSaleBtn = document.getElementById('cancel-sale-btn');
    const saleForm = document.getElementById('sale-form');

    const statusOptionsDefault = ['📋 Compra Registrada', '💰 Pagado', '🚚 Enviado'];

    let state = { sales: [], statusOptions: statusOptionsDefault.slice() };

    // Helpers
    function showToast(msg){ console.log(msg); }
    function isUUID(v){ return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(v||'')); }
    const digits = s => String(s||'').replace(/[^\d]/g,'');

    function openSaleModal(sale) {
      document.getElementById('sale-id').value = sale?.id || '';
      document.getElementById('buyer-name').value = sale?.buyerName || '';
      document.getElementById('buyer-contact').value = sale?.buyerContact || '';
      document.getElementById('product-name').value = sale?.productName || '';
      document.getElementById('total-price').value = sale?.totalPrice || '';
      document.getElementById('product-condition').value = sale?.productCondition || 'Nuevo';
      document.getElementById('deposit').value = sale?.deposit || '';
      document.getElementById('purchase-price-eur').value = sale?.purchasePriceEUR || '';
      document.getElementById('status').value = sale?.status || state.statusOptions[0];
      document.getElementById('adelanto-pagado').checked = !!sale?.adelantoPagado;
      document.getElementById('saldo-pagado').checked = !!sale?.saldoPagado;

      // Enlaces
      const container = document.getElementById('links-container');
      container.innerHTML = '';
      const links = Array.isArray(sale?.productLinks) ? sale.productLinks : [''];
      links.forEach(url => {
        const input = document.createElement('input');
        input.className = 'product-link-input w-full border rounded px-3 py-2';
        input.placeholder = 'https://...';
        input.value = url || '';
        container.appendChild(input);
      });

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeSaleModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('add-link').onclick = () => {
      const container = document.getElementById('links-container');
      const input = document.createElement('input');
      input.className = 'product-link-input w-full border rounded px-3 py-2';
      input.placeholder = 'https://...';
      container.appendChild(input);
    };

    addSaleBtn.onclick = () => openSaleModal();
    cancelSaleBtn.onclick = closeModalBtn.onclick = () => closeSaleModal();

    function renderAll(){
      // KPIs
      kpiCount.textContent = state.sales.length;
      kpiTotal.textContent = (state.sales.reduce((a,b)=>a+(Number(b.totalPrice)||0),0)).toFixed(2);
      kpiPaid.textContent  = state.sales.filter(s=>s.status==='💰 Pagado').length;

      // Tabla
      tableBody.innerHTML = '';
      for (const s of state.sales) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";

        const phoneDigits = digits(s.buyerContact);
        const waHref = phoneDigits ? `https://wa.me/${phoneDigits}?text=${encodeURIComponent('Hola ' + (s.buyerName||''))}` : null;

        tr.innerHTML = `
          <td class="p-3">${s.buyerName||''}</td>
          <td class="p-3">
            ${waHref
              ? `<a class="text-green-600 hover:underline" target="_blank" rel="noopener" href="${waHref}">${s.buyerContact||''}</a>`
              : (s.buyerContact||'—')}
          </td>
          <td class="p-3">${s.productName||''}</td>
          <td class="p-3">S/ ${(Number(s.totalPrice)||0).toFixed(2)}</td>
          <td class="p-3">
            <select class="status-select border rounded px-2 py-1" data-sale-id="${s.id}">
              ${state.statusOptions.map(opt => `<option ${opt===s.status?'selected':''}>${opt}</option>`).join('')}
            </select>
          </td>
          <td class="p-3">
            <button class="text-blue-600 hover:underline" data-action="edit" data-sale-id="${s.id}">Editar</button>
            <button class="text-red-600 hover:underline ml-3" data-action="delete" data-sale-id="${s.id}">Borrar</button>
          </td>
        `;
        tableBody.appendChild(tr);
      }
    }

    // Submit (crear/editar)
    saleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('sale-id').value.trim();

      const productLinks = Array.from(document.querySelectorAll('.product-link-input'))
        .map(i => i.value).filter(Boolean);

      const saleData = {
        buyerName: document.getElementById('buyer-name').value.trim(),
        buyerContact: document.getElementById('buyer-contact').value.trim(),
        productName: document.getElementById('product-name').value.trim(),
        productImage: '', // si luego usas storage, aquí guardas la URL
        productCondition: document.getElementById('product-condition').value,
        productLinks,
        totalPrice: parseFloat(document.getElementById('total-price').value) || 0,
        deposit: parseFloat(document.getElementById('deposit').value) || 0,
        purchasePriceEUR: parseFloat(document.getElementById('purchase-price-eur').value) || 0,
        adelantoPagado: document.getElementById('adelanto-pagado').checked,
        saldoPagado: document.getElementById('saldo-pagado').checked,
        status: document.getElementById('status').value || state.statusOptions[0],
      };

      try {
        if (id && isUUID(id)) {
          await actualizarVentaSupabase(id, saleData);
          alert('✅ Venta actualizada');
        } else {
          await guardarVentaSupabase({ date: new Date().toISOString(), ...saleData });
          alert('✅ Venta registrada');
        }
        await loadFromSupabase();
        renderAll();
        closeSaleModal();
      } catch (err) {
        console.error(err);
        alert('Error guardando en Supabase: ' + (err?.message || err));
      }
    });

    // Cambiar estado
    document.getElementById('sales-table-body').addEventListener('change', async (e) => {
      if (e.target.classList.contains('status-select')) {
        const saleId = e.target.dataset.saleId;
        const newStatus = e.target.value;

        if (!isUUID(saleId)) {
          alert('Este registro es local (sin UUID). Usa "Migrar a la nube" primero.');
          // revertir visual
          const row = state.sales.find(s => String(s.id)===String(saleId));
          if (row) e.target.value = row.status;
          return;
        }

        try {
          await actualizarVentaSupabase(saleId, { status: newStatus });
          await loadFromSupabase();
          renderAll();
          showToast('Estado actualizado');
        } catch (err) {
          console.error(err);
          alert('Error actualizando estado: ' + (err?.message || err));
        }
      }
    });

    // Acciones editar/borrar
    document.getElementById('sales-table-body').addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;

      const id = btn.dataset.saleId;
      const action = btn.dataset.action;

      if (!isUUID(id)) {
        alert('Este registro es local (sin UUID). Usa "Migrar a la nube" primero.');
        return;
      }

      if (action === 'edit') {
        const sale = state.sales.find(s => String(s.id) === String(id));
        if (sale) openSaleModal(sale);
        return;
      }

      if (action === 'delete') {
        if (confirm('¿Eliminar venta?')) {
          try {
            await borrarVentaSupabase(id);
            await loadFromSupabase();
            renderAll();
            showToast('🗑️ Venta eliminada');
          } catch (err) {
            console.error(err);
            alert('Error eliminando: ' + (err?.message || err));
          }
        }
        return;
      }
    });

    // Migración local -> nube
    document.getElementById('migrate-btn')?.addEventListener('click', async () => {
      try {
        const raw = localStorage.getItem('proSalesDashboard');
        if (!raw) { alert('No hay datos locales para migrar'); return; }
        const obj = JSON.parse(raw);
        const sales = Array.isArray(obj?.sales) ? obj.sales : [];
        if (!sales.length) { alert('No hay ventas locales para migrar'); return; }

        if (!window.supabase) { alert('Supabase no está inicializado'); return; }

        let migrated = 0, skipped = 0;
        for (const s of sales) {
          if (isUUID(s.id)) { skipped++; continue; } // ya es de la nube
          const row = {
            date: s.date || new Date().toISOString(),
            buyer_name: s.buyerName || '',
            buyer_contact: s.buyerContact || '',
            product_name: s.productName || '',
            product_image_url: s.productImage || '',
            product_condition: s.productCondition || 'Nuevo',
            product_links: Array.isArray(s.productLinks) ? s.productLinks : [],
            purchase_price_eur: Number(s.purchasePriceEUR || 0),
            total_price: Number(s.totalPrice || 0),
            deposit: Number(s.deposit || 0),
            adelanto_pagado: !!s.adelantoPagado,
            saldo_pagado: !!s.saldoPagado,
            status: s.status || state.statusOptions[0]
          };
          const { error } = await window.supabase.from('sales').insert(row);
          if (!error) migrated++; else console.error('Migración error', error, row);
        }

        await loadFromSupabase();
        renderAll();
        alert(`✅ Migración completada. Migradas: ${migrated}. Omitidas (ya en nube): ${skipped}.`);
      } catch (e) {
        console.error(e);
        alert('Error en migración: ' + (e?.message || e));
      }
    });

    // Carga inicial (si no hay Supabase aún, el módulo lo añadirá)
    function loadState(){ /* mantenido para compatibilidad si quieres leer local */ }
    document.addEventListener('DOMContentLoaded', async () => {
      loadState();
      try {
        if (typeof loadFromSupabase === 'function') {
          await loadFromSupabase();
        }
      } catch (e) {
        console.warn('No se pudo cargar desde Supabase en el arranque:', e);
      }
      renderAll();
    });
  </script>

  <!-- Supabase (module) -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // 👉 Reemplaza con tus valores reales si cambian:
    const SUPABASE_URL = 'https://adwcysfeekzpyfrvzomu.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkd2N5c2ZlZWt6cHlmcnZ6b211Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MDEzODMsImV4cCI6MjA3NTI3NzM4M30.JXfO0yb0kpdoLyUQGzTROZAbI1jQVPtXd3vEhfswmDQ'

    window.SUPABASE_URL = SUPABASE_URL
    window.SUPABASE_ANON_KEY = SUPABASE_ANON_KEY

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase

    // API
    window.loadFromSupabase = async function () {
      const { data, error } = await supabase.from('sales').select('*').order('created_at', { ascending: false })
      if (error) throw error
      window.state = window.state || {}
      window.state.sales = (data || []).map(r => ({
        id: r.id, // UUID
        date: r.date || r.created_at,
        buyerName: r.buyer_name || '',
        buyerContact: r.buyer_contact || '',
        productName: r.product_name || '',
        productImage: r.product_image_url || '',
        productCondition: r.product_condition || 'Nuevo',
        productLinks: Array.isArray(r.product_links) ? r.product_links : [],
        purchasePriceEUR: Number(r.purchase_price_eur || 0),
        totalPrice: Number(r.total_price || 0),
        deposit: Number(r.deposit || 0),
        adelantoPagado: !!r.adelanto_pagado,
        saldoPagado: !!r.saldo_pagado,
        status: r.status || (window.state?.statusOptions ? window.state.statusOptions[0] : '📋 Compra Registrada')
      }))
      return window.state.sales
    }

    window.guardarVentaSupabase = async function (sale) {
      const row = {
        date: sale.date || new Date().toISOString(),
        buyer_name: sale.buyerName || '',
        buyer_contact: sale.buyerContact || '',
        product_name: sale.productName || '',
        product_image_url: sale.productImage || '',
        product_condition: sale.productCondition || 'Nuevo',
        product_links: Array.isArray(sale.productLinks) ? sale.productLinks : [],
        purchase_price_eur: Number(sale.purchasePriceEUR || 0),
        total_price: Number(sale.totalPrice || 0),
        deposit: Number(sale.deposit || 0),
        adelanto_pagado: !!sale.adelantoPagado,
        saldo_pagado: !!sale.saldoPagado,
        status: sale.status || (window.state?.statusOptions ? window.state.statusOptions[0] : '📋 Compra Registrada')
      }
      const { data, error } = await supabase.from('sales').insert(row).select().limit(1).single()
      if (error) throw error
      return data
    }

    window.actualizarVentaSupabase = async function (id, patch) {
      if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(id||'')))
        throw new Error('ID inválido (no UUID)')
      const row = {
        buyer_name: patch.buyerName,
        buyer_contact: patch.buyerContact,
        product_name: patch.productName,
        product_image_url: patch.productImage,
        product_condition: patch.productCondition,
        product_links: Array.isArray(patch.productLinks) ? patch.productLinks : undefined,
        purchase_price_eur: patch.purchasePriceEUR,
        total_price: patch.totalPrice,
        deposit: patch.deposit,
        adelanto_pagado: patch.adelantoPagado,
        saldo_pagado: patch.saldoPagado,
        status: patch.status
      }
      const { error } = await supabase.from('sales').update(row).eq('id', id)
      if (error) throw error
    }

    window.borrarVentaSupabase = async function (id) {
      if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(id||'')))
        throw new Error('ID inválido (no UUID)')
      const { error } = await supabase.from('sales').delete().eq('id', id)
      if (error) throw error
    }

    // 🔁 Realtime: refresca automáticamente al detectar cambios
    const channel = supabase
      .channel('sales-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'sales' }, async () => {
        try { await window.loadFromSupabase(); if (typeof renderAll==='function') renderAll(); }
        catch(e){ console.error('Realtime refresh error:', e); }
      })
      .subscribe()
  </script>
</body>
</html>
