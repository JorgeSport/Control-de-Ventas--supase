<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Ventas - Supabase</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- ENCABEZADO -->
  <header class="bg-indigo-600 text-white p-4 text-center font-bold text-2xl">
    Control de Ventas
  </header>

  <!-- CONTENEDOR -->
  <main class="max-w-5xl mx-auto p-4">
    <div class="flex justify-between mb-4">
      <button id="add-sale-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">
        Registrar Venta
      </button>
    </div>

    <!-- TABLA -->
    <table class="w-full bg-white rounded shadow">
      <thead class="bg-indigo-600 text-white">
        <tr>
          <th class="p-2">Cliente</th>
          <th class="p-2">Producto</th>
          <th class="p-2">Total</th>
          <th class="p-2">Estado</th>
          <th class="p-2">Acciones</th>
        </tr>
      </thead>
      <tbody id="sales-table-body"></tbody>
    </table>
  </main>

  <!-- MODAL -->
  <div id="sale-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded w-96 relative">
      <h2 class="text-xl font-bold mb-4">Registrar Venta</h2>
      <form id="sale-form" class="space-y-3">
        <input type="hidden" id="sale-id">
        <input id="buyerName" type="text" placeholder="Nombre del cliente" class="w-full p-2 border rounded" required>
        <input id="productName" type="text" placeholder="Producto" class="w-full p-2 border rounded" required>
        <input id="totalPrice" type="number" placeholder="Total" class="w-full p-2 border rounded" required>
        <select id="status" class="w-full p-2 border rounded">
          <option>ğŸ“‹ Compra Registrada</option>
          <option>ğŸ’° Pagado</option>
          <option>ğŸšš Enviado</option>
        </select>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancel-sale-btn" class="bg-gray-400 px-4 py-2 rounded text-white">Cancelar</button>
          <button type="submit" class="bg-green-600 px-4 py-2 rounded text-white">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS PRINCIPAL -->
  <script>
  const tableBody = document.getElementById('sales-table-body');
  const modal = document.getElementById('sale-modal');
  const saleForm = document.getElementById('sale-form');
  const addSaleBtn = document.getElementById('add-sale-btn');
  const cancelSaleBtn = document.getElementById('cancel-sale-btn');

  let state = { sales: [], statusOptions: ['ğŸ“‹ Compra Registrada', 'ğŸ’° Pagado', 'ğŸšš Enviado'] };

  function showToast(msg) { console.log(msg); }

  function renderAll() {
    tableBody.innerHTML = '';
    state.sales.forEach(sale => {
      const tr = document.createElement('tr');
      tr.className = "border-b hover:bg-gray-50";
      tr.innerHTML = `
        <td class="p-2">${sale.buyerName}</td>
        <td class="p-2">${sale.productName}</td>
        <td class="p-2">S/ ${sale.totalPrice}</td>
        <td class="p-2">
          <select data-sale-id="${sale.id}" class="status-select border rounded p-1">
            ${state.statusOptions.map(st => `<option ${sale.status===st?'selected':''}>${st}</option>`).join('')}
          </select>
        </td>
        <td class="p-2">
          <button data-action="edit" data-sale-id="${sale.id}" class="text-blue-600">Editar</button>
          <button data-action="delete" data-sale-id="${sale.id}" class="text-red-600 ml-2">Borrar</button>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  function openSaleModal(sale=null) {
    modal.classList.remove('hidden');
    saleForm.reset();
    if (sale) {
      document.getElementById('sale-id').value = sale.id;
      document.getElementById('buyerName').value = sale.buyerName;
      document.getElementById('productName').value = sale.productName;
      document.getElementById('totalPrice').value = sale.totalPrice;
      document.getElementById('status').value = sale.status;
    }
  }

  function closeSaleModal() {
    modal.classList.add('hidden');
  }

  addSaleBtn.onclick = () => openSaleModal();
  cancelSaleBtn.onclick = () => closeSaleModal();

  // SUBMIT FORMULARIO
  saleForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('sale-id').value.trim();
    const saleData = {
      buyerName: document.getElementById('buyerName').value,
      productName: document.getElementById('productName').value,
      totalPrice: parseFloat(document.getElementById('totalPrice').value),
      status: document.getElementById('status').value
    };
    try {
      if (id) {
        await actualizarVentaSupabase(id, saleData);
        alert('âœ… Venta actualizada');
      } else {
        await guardarVentaSupabase(saleData);
        alert('âœ… Venta registrada');
      }
      await loadFromSupabase();
      renderAll();
      closeSaleModal();
    } catch (err) {
      console.error(err);
      alert('Error guardando en Supabase: ' + (err.message || err));
    }
  });

  // CAMBIO DE ESTADO
  tableBody.addEventListener('change', async (e) => {
    if (e.target.classList.contains('status-select')) {
      const saleId = e.target.dataset.saleId;
      const newStatus = e.target.value;
      try {
        await actualizarVentaSupabase(saleId, { status: newStatus });
        alert('âœ… Estado actualizado');
      } catch (err) {
        alert('Error actualizando estado: ' + (err.message || err));
      }
    }
  });

  // CLICK ACCIONES
  tableBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = btn.dataset.saleId;
    const action = btn.dataset.action;
    if (action === 'edit') {
      const sale = state.sales.find(s => s.id === id);
      if (sale) openSaleModal(sale);
    }
    if (action === 'delete') {
      if (confirm('Â¿Eliminar venta?')) {
        try {
          await borrarVentaSupabase(id);
          alert('ğŸ—‘ï¸ Venta eliminada');
          await loadFromSupabase();
          renderAll();
        } catch (err) {
          alert('Error eliminando: ' + (err.message || err));
        }
      }
    }
  });
  </script>

  <!-- SUPABASE -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    const SUPABASE_URL = 'https://adwcysfeekzpyfrvzomu.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkd2N5c2ZlZWt6cHlmcnZ6b211Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MDEzODMsImV4cCI6MjA3NTI3NzM4M30.JXfO0yb0kpdoLyUQGzTROZAbI1jQVPtXd3vEhfswmDQ 
'
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    window.supabase = supabase

    window.loadFromSupabase = async function () {
      const { data, error } = await supabase.from('sales').select('*').order('created_at', { ascending: false })
      if (error) throw error
      window.state.sales = data.map(r => ({
        id: r.id,
        buyerName: r.buyer_name,
        productName: r.product_name,
        totalPrice: r.total_price,
        status: r.status || 'ğŸ“‹ Compra Registrada'
      }))
      return window.state.sales
    }

    window.guardarVentaSupabase = async function (sale) {
      const { error } = await supabase.from('sales').insert({
        buyer_name: sale.buyerName,
        product_name: sale.productName,
        total_price: sale.totalPrice,
        status: sale.status
      })
      if (error) throw error
    }

    window.actualizarVentaSupabase = async function (id, patch) {
      const { error } = await supabase.from('sales').update({
        buyer_name: patch.buyerName,
        product_name: patch.productName,
        total_price: patch.totalPrice,
        status: patch.status
      }).eq('id', id)
      if (error) throw error
    }

    window.borrarVentaSupabase = async function (id) {
      const { error } = await supabase.from('sales').delete().eq('id', id)
      if (error) throw error
    }

    // Carga inicial
    loadFromSupabase().then(renderAll).catch(err => alert('Error cargando datos: ' + err.message))
  </script>
</body>
</html>
